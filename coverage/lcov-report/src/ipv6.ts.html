<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/ipv6.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">All files</a> / <a href="index.html">src</a> ipv6.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>54/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>34/34</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>10/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>52/52</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144</td><td class="line-coverage quiet"><span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14x</span>
<span class="cline-any cline-yes">14x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14x</span>
<span class="cline-any cline-yes">14x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14x</span>
<span class="cline-any cline-yes">14x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">200226x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">200225x</span>
<span class="cline-any cline-yes">15x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">200210x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">200210x</span>
<span class="cline-any cline-yes">200210x</span>
<span class="cline-any cline-yes">200210x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">200210x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">100129x</span>
<span class="cline-any cline-yes">74x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100108x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100108x</span>
<span class="cline-any cline-yes">100108x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100108x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100107x</span>
<span class="cline-any cline-yes">100105x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100105x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">100103x</span>
<span class="cline-any cline-yes">322473x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">322473x</span>
<span class="cline-any cline-yes">66688x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">255785x</span>
<span class="cline-any cline-yes">255785x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33410x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">66693x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">9x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import * as net from 'net';
import { IpAddressError } from './error';
&nbsp;
const hasDot = /\./;
const mappedIpv4 = /(.+):ffff:(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})($|%.+)/;
&nbsp;
function mappedIpv4ToIpv6(ip: string) {
  const matches = ip.match(mappedIpv4);
&nbsp;
  /* istanbul ignore if */
  if (!matches) {
    throw new Error(`not a mapped IPv4 address: ${ip}`);
  }
&nbsp;
  // mapped IPv4 address
  const prefix = matches[1];
  const ipv4 = matches[2];
&nbsp;
  const parts = ipv4.split('.').map(x =&gt; parseInt(x, 10));
&nbsp;
  const segment7 = ((parts[0] &lt;&lt; 8) + parts[1]).toString(16);
  const segment8 = ((parts[2] &lt;&lt; 8) + parts[3]).toString(16);
&nbsp;
  const ipv6Version = `${prefix}:ffff:${segment7}:${segment8}`;
  return getIpv6Segments(ipv6Version);
}
&nbsp;
/**
 * Given an IP address that may have double-colons, expand all segments and return them
 * as an array of 8 segments (16-bit words). As a peformance enhancement (indicated by
 * profiling), for any segment that was missing but should be a '0', returns undefined.
 * @param ip the IPv6 address to expand
 * @throws if the string is not a valid IPv6 address
 */
function getIpv6Segments(ip: string): string[] {
  if (!net.isIPv6(ip)) {
    throw new IpAddressError(`not a valid IPv6 address: ${ip}`);
  }
&nbsp;
  if (hasDot.test(ip)) {
    return mappedIpv4ToIpv6(ip);
  }
&nbsp;
  // break it into an array, including missing "::" segments
  const [beforeChunk, afterChunk] = ip.split('::');
&nbsp;
  const beforeParts = (beforeChunk &amp;&amp; beforeChunk.split(':')) || [];
  const afterParts: string[] = (afterChunk &amp;&amp; afterChunk.split(':')) || [];
  const missingSegments = new Array&lt;string&gt;(8 - (beforeParts.length + afterParts.length));
&nbsp;
  return beforeParts.concat(missingSegments, afterParts);
}
&nbsp;
/**
 * Test if the given IPv6 address is contained in the specified subnet.
 * @param address the IPv6 address to check
 * @param subnet the IPv6 CIDR to test (or an array of them)
 * @throws if the address or subnet are not valid IP addresses, or the CIDR prefix length
 *  is not valid
 */
export function isInSubnet(address: string, subnetOrSubnets: string | string[]) {
  if (Array.isArray(subnetOrSubnets)) {
    return subnetOrSubnets.some(subnet =&gt; isInSubnet(address, subnet));
  }
&nbsp;
  const subnet = subnetOrSubnets;
&nbsp;
  const [subnetAddress, prefixLengthString] = subnet.split('/');
  const prefixLength = parseInt(prefixLengthString, 10);
&nbsp;
  if (!subnetAddress || !Number.isInteger(prefixLength)) {
    throw new IpAddressError(`not a valid IPv6 CIDR subnet: ${subnet}`);
  }
&nbsp;
  // the next two lines throw if the addresses are not valid IPv6 addresses
  const addressSegments = getIpv6Segments(address);
  const subnetSegments = getIpv6Segments(subnetAddress);
&nbsp;
  if (prefixLength &lt; 0 || prefixLength &gt; 128) {
    throw new IpAddressError(
      `not a valid IPv6 prefix length: ${prefixLength} (from ${subnet})`
    );
  }
&nbsp;
  for (let i = 0; i &lt; 8; ++i) {
    const bitCount = Math.min(prefixLength - i * 16, 16);
&nbsp;
    if (bitCount &lt;= 0) {
      break;
    }
&nbsp;
    const maskPart = parseInt('1'.repeat(bitCount) + '0'.repeat(16 - bitCount), 2);
    if (
      (((addressSegments[i] &amp;&amp; parseInt(addressSegments[i], 16)) || 0) &amp; maskPart) !==
      (((subnetSegments[i] &amp;&amp; parseInt(subnetSegments[i], 16)) || 0) &amp; maskPart)
    ) {
      return false;
    }
  }
&nbsp;
  return true;
}
&nbsp;
/** Test if the given IP address is a private/internal IP address. */
export function isPrivate(address: string) {
  return isInSubnet(address, [
    'fe80::/10', // link-local address
    'fc00::/7' // unique local address
  ]);
}
&nbsp;
/** Test if the given IP address is a localhost address. */
export function isLocalhost(address: string) {
  return isInSubnet(address, '::1/128');
}
&nbsp;
/** Test if the given IP address is an IPv4 address mapped onto IPv6 */
export function isIPv4MappedAddress(address: string) {
  return isInSubnet(address, '::ffff:0:0/96');
}
&nbsp;
/** Test if the given IP address is in a known reserved range and not a normal host IP */
export function isReserved(address: string) {
  return isInSubnet(address, [
    '::/128', // unspecified address
    '64:ff9b::/96', // IPv4/IPv6 translation
    '100::/64', // discard prefix
    '2001::/32', // Teredo tunneling
    '2001:10::/28', // deprecated
    '2001:20::/28', // ORCHIDv2
    '2001:db8::/32', // for documentation and examples
    '2002::/16', // 6to4
    'ff00::/8' // multicast
  ]);
}
&nbsp;
/**
 * Test if the given IP address is a special address of any kind (private, reserved,
 * localhost)
 */
export function isSpecial(address: string) {
  return isPrivate(address) || isLocalhost(address) || isReserved(address);
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Wed Feb 14 2018 14:31:52 GMT-0800 (PST)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
